name: generate nightly bundles

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches:
      - release  # For testing workflow changes

jobs:
  # Delete existing nightly release first to avoid conflicts
  cleanup-nightly:
    name: cleanup previous nightly
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Delete previous nightly release
        run: |
          gh release view nightly >/dev/null 2>&1 && \
          gh release delete nightly --yes --cleanup-tag || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-win:
    name: build windows packages
    needs: [cleanup-nightly]
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        architecture: ["x64"]
        ai_ready: [1]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Put current date into a variable
        run: |
          $DATE=& Get-Date -format yyyy-MM-dd
          echo "DATE=$DATE" >> $env:GITHUB_ENV

      - name: Put current commit hash in a variable
        run: |
          $COMMIT=$(git rev-parse HEAD)
          echo "COMMIT=$COMMIT" >> $env:GITHUB_ENV

      - uses: astral-sh/setup-uv@v5
        with:
          python-version: 3.12
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: install venv and sync dependencies
        run: |
          uv sync --all-extras

      - name: Get InVesalius version
        run: |
          $INVESALIUS_VERSION=$(uv run python -c "import importlib.metadata; print(importlib.metadata.version('invesalius'))")
          echo "INVESALIUS_VERSION=$INVESALIUS_VERSION" >> $env:GITHUB_ENV

      - name: copy .pyd files to invesalius_cy
        run: Copy-Item -Path invesalius_cy\Release\* -Destination invesalius_cy -Recurse -Force

      # Cache AI weights to speed up builds
      - name: Cache AI weights
        if: ${{ matrix.ai_ready == 1 }}
        id: cache-ai-weights
        uses: actions/cache@v4
        with:
          path: ./ai/
          key: ai-weights-v1

      - name: Download mandible ai weight
        if: ${{ matrix.ai_ready == 1 && steps.cache-ai-weights.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p ./ai/mandible_jit_ct/
          curl -L -o ./ai/mandible_jit_ct/mandible_jit_ct.pt "https://raw.githubusercontent.com/invesalius/weights/main/mandible_ct/mandible_jit_ct.pt"

      - name: Download cranioplasty binary ai weight
        if: ${{ matrix.ai_ready == 1 && steps.cache-ai-weights.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p ./ai/cranioplasty_jit_ct_binary/
          curl -L -o ./ai/cranioplasty_jit_ct_binary/cranioplasty_jit_ct_binary.pt "https://raw.githubusercontent.com/invesalius/weights/main/cranioplasty_jit_ct_binary/cranioplasty_jit_ct_binary.pt"

      - name: Download cranioplasty gray ai weight
        if: ${{ matrix.ai_ready == 1 && steps.cache-ai-weights.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p ./ai/cranioplasty_jit_ct_gray/
          curl -L -o ./ai/cranioplasty_jit_ct_gray/cranioplasty_jit_ct_gray.pt "https://raw.githubusercontent.com/invesalius/weights/main/cranioplasty_jit_ct_gray/cranioplasty_jit_ct_gray.pt"

      - name: Download trachea ai weight
        if: ${{ matrix.ai_ready == 1 && steps.cache-ai-weights.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p ./ai/trachea_ct/
          curl -L -o ./ai/trachea_ct/trachea_ct.pt "https://github.com/tfmoraes/deep_trachea_torch/releases/download/v1.0/weights.pt"

      - name: Download brain ai weight
        if: ${{ matrix.ai_ready == 1 && steps.cache-ai-weights.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p ./ai/brain_mri_t1/
          curl -L -o ./ai/brain_mri_t1/brain_mri_t1.pt "https://github.com/tfmoraes/deepbrain_torch/releases/download/v1.1.0/weights.pt"

      - name: Generate InVesalius .exe file
        run: |
          cp ./bundle_tools/win/app.spec ./  
          uv run pyinstaller app.spec --clean --noconfirm
          mkdir installer

      - name: Generate InVesalius installer - win64 ai-ready build
        run: ISCC.exe /Oinstaller /F"invesalius-${{ env.INVESALIUS_VERSION }}_nightly_ai-ready_win64" /DMyAppVersion=${{ env.INVESALIUS_VERSION }} ./bundle_tools/win/generate_installer.iss

      - name: Upload artifact of package ai-ready file
        if: ${{ matrix.ai_ready == 1 }}
        uses: actions/upload-artifact@v4
        with:
          overwrite: true
          name: invesalius_package_exe_ai-ready
          retention-days: 2
          path: ./installer/*.exe

  build-mac:
    name: build mac packages
    needs: [cleanup-nightly]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            architecture: arm64
          - os: macos-13
            architecture: x86_64
        ai_ready: [1]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Put current date into a variable
        run: echo "DATE=$(date +"%Y-%m-%d")" >> $GITHUB_ENV

      - name: Put current commit hash in a variable
        run: echo "COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV

      - uses: astral-sh/setup-uv@v5
        with:
          python-version: 3.12
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: install venv and sync dependencies
        run: |
          brew install libomp
          export CFLAGS="-I$(brew --prefix libomp)/include"
          export CPPFLAGS="-I$(brew --prefix libomp)/include"
          export LDFLAGS="-L$(brew --prefix libomp)/lib"
          OpenMP_ROOT=$(brew --prefix)/opt/libomp uv sync --all-extras

      - name: Get InVesalius version
        run: |
          INVESALIUS_VERSION=$(uv run python -c "import importlib.metadata; print(importlib.metadata.version('invesalius'))")
          echo "INVESALIUS_VERSION=$INVESALIUS_VERSION" >> $GITHUB_ENV

      - name: copy .so files to invesalius_cy
        run: |
          if [ -d "invesalius_cy/Release" ]; then
            cp invesalius_cy/Release/* invesalius_cy/
          fi

      # Cache AI weights to speed up builds
      - name: Cache AI weights
        if: ${{ matrix.ai_ready == 1 }}
        id: cache-ai-weights
        uses: actions/cache@v4
        with:
          path: ./ai/
          key: ai-weights-v1

      - name: Download mandible ai weight
        if: ${{ matrix.ai_ready == 1 && steps.cache-ai-weights.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p ./ai/mandible_jit_ct/
          curl -L -o ./ai/mandible_jit_ct/mandible_jit_ct.pt "https://raw.githubusercontent.com/invesalius/weights/main/mandible_ct/mandible_jit_ct.pt"

      - name: Download cranioplasty binary ai weight
        if: ${{ matrix.ai_ready == 1 && steps.cache-ai-weights.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p ./ai/cranioplasty_jit_ct_binary/
          curl -L -o ./ai/cranioplasty_jit_ct_binary/cranioplasty_jit_ct_binary.pt "https://raw.githubusercontent.com/invesalius/weights/main/cranioplasty_jit_ct_binary/cranioplasty_jit_ct_binary.pt"

      - name: Download cranioplasty gray ai weight
        if: ${{ matrix.ai_ready == 1 && steps.cache-ai-weights.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p ./ai/cranioplasty_jit_ct_gray/
          curl -L -o ./ai/cranioplasty_jit_ct_gray/cranioplasty_jit_ct_gray.pt "https://raw.githubusercontent.com/invesalius/weights/main/cranioplasty_jit_ct_gray/cranioplasty_jit_ct_gray.pt"

      - name: Download trachea ai weight
        if: ${{ matrix.ai_ready == 1 && steps.cache-ai-weights.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p ./ai/trachea_ct/
          curl -L -o ./ai/trachea_ct/trachea_ct.pt "https://github.com/tfmoraes/deep_trachea_torch/releases/download/v1.0/weights.pt"

      - name: Download brain ai weight
        if: ${{ matrix.ai_ready == 1 && steps.cache-ai-weights.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p ./ai/brain_mri_t1/
          curl -L -o ./ai/brain_mri_t1/brain_mri_t1.pt "https://github.com/tfmoraes/deepbrain_torch/releases/download/v1.1.0/weights.pt"

      - name: Generate InVesalius .app bundle
        run: |
          cp ./bundle_tools/mac/app.spec ./
          uv run pyinstaller app.spec --clean --noconfirm

      - name: Setup node(npm)
        uses: actions/setup-node@v4
        with:
          node-version: '20.1'

      - name: Create DMG
        run: |
          npm install --global create-dmg
          create-dmg "dist/InVesalius 3.1.app" || true
          # Verify DMG was created
          DMG_FILE=$(ls -1 *.dmg 2>/dev/null | head -n1)
          if [ -z "$DMG_FILE" ]; then
            echo "Error: DMG file was not created!"
            exit 1
          fi
          mv "$DMG_FILE" "InVesalius_${{ env.INVESALIUS_VERSION }}_${{ matrix.architecture }}.dmg"

      - name: Upload artifact of package ai-ready file
        if: ${{ matrix.ai_ready == 1 }}
        uses: actions/upload-artifact@v4
        with:
          overwrite: true
          name: invesalius_package_app_ai-ready_${{ matrix.architecture }}
          retention-days: 2
          path: ./*.dmg

  publish_packages:
    name: publish packages
    needs: [build-mac, build-win]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: invesalius_package_*
          merge-multiple: true
          path: ./

      - name: Show collected files
        run: ls -lh

      - name: Update Nightly Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: "Nightly Build"
          body: |
            This is a nightly release of InVesalius.
            It includes builds for:
            - macOS ARM
            - macOS Intel
            - Windows x64
            These are unstable compared to official releases â€” **use with caution**!
          draft: false
          prerelease: true
          files: |
            ./*.dmg
            ./*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
